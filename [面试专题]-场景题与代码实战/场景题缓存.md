## 125.æ–¹æ³•å¼•ç”¨ï¼šåŸºäºå‡½æ•°å¼æ¥å£,èƒ½å¤Ÿæ™ºèƒ½æ¨æ–­ç±»å‹ï¼Œä¸streamç»“åˆç´§å¯†ã€‚å½¢å¦‚sorted(Person::compare)å‰è€…æ˜¯ç±»å,åè€…æ˜¯é™æ€æ–¹æ³•

> # Javaæ–¹æ³•å¼•ç”¨ vs ä¼ ç»ŸLambdaï¼šä¸ºä»€ä¹ˆåº”è¯¥æ‹¥æŠ±åŒå†’å·è¯­æ³•ï¼Ÿ
>
> åœ¨Javaå‡½æ•°å¼ç¼–ç¨‹ä¸­ï¼Œæ–¹æ³•å¼•ç”¨ï¼ˆMethod Referencesï¼‰ä¸Lambdaè¡¨è¾¾å¼å°±åƒä¸€å¯¹å­ªç”Ÿå…„å¼Ÿã€‚å®ƒä»¬éƒ½åŸºäºå‡½æ•°å¼æ¥å£å®ç°ï¼Œä½†åœ¨å®é™…å¼€å‘ä¸­ï¼Œæ–¹æ³•å¼•ç”¨æ­£åœ¨ä»¥ç‹¬ç‰¹çš„ä¼˜åŠ¿æ”¹å˜æˆ‘ä»¬çš„ç¼–ç æ–¹å¼ã€‚æœ¬æ–‡é€šè¿‡å¯¹æ¯”åˆ†æï¼Œæ­ç¤ºè¿™ä¸ªè¯­æ³•ç³–èƒŒåçš„æ·±å±‚ä»·å€¼ã€‚
>
> æ ¸å¿ƒåŒºåˆ«å¯¹æ¯”
>
> ### 1. ä»£ç ç®€æ´æ€§ï¼ˆä»¥æ’åºä¸ºä¾‹ï¼‰
>
> **ä¼ ç»ŸLambdaå†™æ³•**
> ```java
> persons.stream()
>        .sorted((a, b) -> Person.compareByAge(a, b))
> ````
>
> **æ–¹æ³•å¼•ç”¨å†™æ³•**
>
> ```java
> persons.stream()
>        .sorted(Person::compareByAge)
> ```
>
> > ğŸ’¡ åŒå†’å·è¯­æ³•æ¶ˆé™¤å†—ä½™å‚æ•°ä¼ é€’ï¼Œä»£ç é•¿åº¦ç¼©çŸ­40%ã€‚åœ¨é“¾å¼è°ƒç”¨ä¸­ï¼Œè¿™ç§ç®€æ´æ€§ä¼šè¢«å¤šæ¬¡æ”¾å¤§ã€‚
>
> ### 2. ç±»å‹æ¨æ–­æ™ºèƒ½åº¦
>
> ```java
> // éœ€è¦æ˜¾å¼å£°æ˜å‚æ•°ç±»å‹
> BiFunction<Person, Person, Integer> comparator = 
>     (Person a, Person b) -> a.compareByAge(b);
> 
> // ç¼–è¯‘å™¨è‡ªåŠ¨æ¨æ–­ç±»å‹
> BiFunction<Person, Person, Integer> comparator = Person::compareByAge;
> ```
>
> > ğŸ§  ç¼–è¯‘å™¨é€šè¿‡`BiFunction`çš„å‡½æ•°å¼æ¥å£å®šä¹‰ï¼Œåå‘æ¨å¯¼å‡ºæ–¹æ³•å¼•ç”¨å‚æ•°ç±»å‹ã€‚è¿™ç§åŒå‘ç±»å‹æ¨æ–­æ˜¯Lambdaåšä¸åˆ°çš„ã€‚
>
> ### 3. ä¸Stream APIçš„å¥‘åˆåº¦
>
> ```java
> // ä¼ ç»Ÿæ–¹å¼
> list.stream()
>     .map(s -> s.toUpperCase())
>     .filter(s -> s.startsWith("A"))
>     .forEach(s -> System.out.println(s));
> 
> // æ–¹æ³•å¼•ç”¨æ–¹å¼
> list.stream()
>     .map(String::toUpperCase)
>     .filter(s -> s.startsWith("A"))
>     .forEach(System.out::println);
> ```
>
> > âš¡ æ–¹æ³•å¼•ç”¨ä¸Streamå½¢æˆã€Œè¯­ä¹‰åŒ–ç®¡é“ã€ï¼Œæ¯ä¸ªæ“ä½œéƒ½åƒè‡ªç„¶è¯­è¨€æè¿°ä¸šåŠ¡é€»è¾‘ã€‚
>
> ***
>
> ## æ–¹æ³•å¼•ç”¨çš„å››å¤§ä¼˜åŠ¿
>
> ### 1. ç±»å‹å®‰å…¨ç›¾ç‰Œ
>
> ```java
> // ç¼–è¯‘æ—¶ç«‹å³å‘ç°ç±»å‹é”™è¯¯
> Comparator<Person> wrongComparator = Person::compareByName; // å¦‚æœæ–¹æ³•ä¸å­˜åœ¨åˆ™æŠ¥é”™
> 
> // Lambdaå¯èƒ½åœ¨è¿è¡Œæ—¶æ‰æš´éœ²é—®é¢˜
> Comparator<Person> risky = (a,b) -> a.nonExistMethod(); // å»¶è¿ŸæŠ¥é”™
> ```
>
> ### 2. å¯¹è±¡è€¦åˆè§£è¯
>
> ```java
> // é™æ€æ–¹æ³•å¼•ç”¨ï¼šPerson::compareBySalary
> // å®ä¾‹æ–¹æ³•å¼•ç”¨ï¼šperson::getName
> // æ„é€ å™¨å¼•ç”¨ï¼šEmployee::new
> ```
>
> æ¯ç§å¼•ç”¨ç±»å‹éƒ½æ˜ç¡®æŒ‡å®šæ–¹æ³•æ¥æºï¼Œé¿å…éšå¼è€¦åˆã€‚
>
> ### 3. å¯ç»´æŠ¤æ€§å€å¢å™¨
>
> ```java
> // çœ‹åˆ°Device::checkStatus ç«‹åˆ»æ˜ç™½æ ¡éªŒé€»è¾‘
> devices.stream().filter(Device::checkStatus)
> 
> // Lambdaéœ€è¦æ·±å…¥æŸ¥çœ‹å®ç°ç»†èŠ‚
> devices.stream().filter(d -> d.getState() == State.ON && !d.isError())
> ```
>
> > ğŸ” æ–¹æ³•å¼•ç”¨å°†ä¸šåŠ¡è¯­ä¹‰æå‡åˆ°æ–¹æ³•åçº§åˆ«ï¼Œå‡å°‘ä»£ç é˜…è¯»æ—¶çš„è®¤çŸ¥è´Ÿæ‹…ã€‚
>
> ### 4. æ€§èƒ½ä¼˜åŒ–ç©ºé—´
>
> è™½ç„¶HotSpotä¼šå¯¹äºŒè€…åšåŒæ ·ä¼˜åŒ–ï¼Œä½†æ–¹æ³•å¼•ç”¨æ›´åˆ©äºï¼š
>
> *   æå‰ç¼–è¯‘éªŒè¯
> *   IDEé™æ€åˆ†æ
> *   å­—èŠ‚ç ä¼˜åŒ–
>
> ***
>
> ## æœ€ä½³å®è·µåœºæ™¯
>
> 1.  **æ›¿æ¢ç®€å•Lambda**ï¼šå½“Lambdaä»…è°ƒç”¨å·²æœ‰æ–¹æ³•æ—¶
> 2.  **æ„é€ å™¨ä»£ç†**ï¼š`Stream.map(Employee::new)`
> 3.  **å¤šçº§å¯¹è±¡æ“ä½œ**ï¼š`user.getAddress()::getPostcode`
> 4.  **ç»„åˆå¼ç¼–ç¨‹**ï¼š`Comparator.comparing(Person::getBirthday)`
>
> ***
>
> ## ä½•æ—¶åšæŒç”¨Lambdaï¼Ÿ
>
> *   éœ€è¦è‡ªå®šä¹‰é€»è¾‘æ—¶ï¼š`(x, y) -> x*2 + y`
> *   å¤šè¡Œä»£ç å—å¤„ç†æ—¶
> *   éœ€è¦ä¿®æ”¹å¤–éƒ¨å˜é‡æ—¶
>
> 
>
> > é€‰æ‹©ä¾æ®ï¼šä»£ç æ˜¯å¦çº¯ç²¹è½¬å‘æ–¹æ³•è°ƒç”¨
>
> ***
>
> ## è¿›é˜¶æŠ€å·§
>
> **ç±»å‹æ¨æ–­çš„ç‰¹æ®Šæƒ…å†µ**
>
> ```java
> // ç›¸åŒæ–¹æ³•åæ—¶çš„æ˜¾å¼ç±»å‹æŒ‡å®š
> Stream.<Person>of().sorted(Person::compareByAge)
> ```
>
> **ä¸Optionalçš„é…åˆ**
>
> ```java
> Optional.ofNullable(user)
>         .map(User::getProfile)
>         .map(Profile::getAvatarUrl)
>         .ifPresent(System.out::println);
> ```
>
> ***
>
> ## æ€»ç»“
>
> æ–¹æ³•å¼•ç”¨ä¸æ˜¯ç®€å•çš„è¯­æ³•ç³–ï¼Œè€Œæ˜¯ï¼š
>
> *   å£°æ˜å¼ç¼–ç¨‹æ€æƒ³çš„ä½“ç°
> *   ç±»å‹ç³»ç»Ÿçš„å»¶ä¼¸
> *   å¯ç»´æŠ¤æ€§ä¸å¯é æ€§çš„ä¿éšœ
>
> å½“æˆ‘ä»¬åœ¨`forEach(System.out::println)`å’Œ`sorted(Person::compareByAge)`ä¸­å¤§é‡ä½¿ç”¨æ—¶ï¼Œå®é™…ä¸Šæ˜¯åœ¨ç”¨ä»£ç å®£å‘Šï¼šè¿™ä¸ªæ“ä½œä¸æ˜¯åˆ›æ–°é€»è¾‘ï¼Œè€Œæ˜¯å¯¹å·²æœ‰è¡Œä¸ºçš„ç²¾ç¡®å¤ç”¨ã€‚
>
> **æœ€åå»ºè®®**ï¼šåœ¨ä»£ç è¯„å®¡ä¸­åŠ å…¥ã€Œæ–¹æ³•å¼•ç”¨æ£€æŸ¥é¡¹ã€ï¼ŒæŠŠå¯æ›¿æ¢çš„Lambdaé€ä¸ªå‡çº§ï¼Œè®©ä»£ç æ•£å‘å‡ºå‡½æ•°å¼ç¼–ç¨‹çš„çœŸæ­£é­…åŠ›ï¼

## 126.SpringBootæ¥å£çš„QPSä¸å“åº”æ—¶é—´ç›‘æ§æ–¹æ³•ï¼šactuator+prometheus+grafana



---

> # ç”¨Dockeræ­å»ºSpringBootç›‘æ§ç³»ç»Ÿï¼šQPSä¸å“åº”æ—¶é—´å¯è§†åŒ–å®æˆ˜
>
> åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œæ¥å£çš„QPSï¼ˆæ¯ç§’æŸ¥è¯¢ç‡ï¼‰å’Œå“åº”æ—¶é—´æ˜¯è¡¡é‡æœåŠ¡å¥åº·åº¦çš„é‡è¦æŒ‡æ ‡ã€‚æœ¬æ–‡å°†æ‰‹æŠŠæ‰‹æ•™ä½ ä½¿ç”¨Dockeræ­å»ºå®Œæ•´çš„ç›‘æ§ç³»ç»Ÿï¼Œå¹¶é€šè¿‡ä»£ç ç¤ºä¾‹å±•ç¤ºå…·ä½“å®ç°ã€‚
>
> ## æŠ€æœ¯æ ˆå…¨æ™¯å›¾
> ```mermaid
> graph LR
> A[SpringBootåº”ç”¨] --> B(Actuatorç«¯ç‚¹)
> B --> C(Prometheus)
> C --> D{Grafana}
> ```
>
> ---
>
> ## ä¸€ã€SpringBootåº”ç”¨é…ç½®
>
> ### 1. æ·»åŠ ä¾èµ–
> ```xml
> <!-- pom.xml -->
> <dependency>
>     <groupId>org.springframework.boot</groupId>
>     <artifactId>spring-boot-starter-actuator</artifactId>
> </dependency>
> <dependency>
>     <groupId>io.micrometer</groupId>
>     <artifactId>micrometer-registry-prometheus</artifactId>
> </dependency>
> ```
>
> ### 2. é…ç½®Actuator
> ```yaml
> # application.yml
> management:
>   endpoints:
>     web:
>       exposure:
>         include: prometheus,health,metrics
>   metrics:
>     tags:
>       application: ${spring.application.name}
> ```
>
> ### 3. éªŒè¯ç«¯ç‚¹
> ```bash
> curl http://localhost:8080/actuator/prometheus
> # åº”çœ‹åˆ°ç±»ä¼¼æŒ‡æ ‡è¾“å‡º
> # http_server_requests_seconds_count{...} 1234.0
> ```
>
> ---
>
> ## äºŒã€Dockeréƒ¨ç½²ä¸­é—´ä»¶
>
> ### 1. docker-composeç¼–æ’
> ```yaml
> # monitoring-stack.yml
> version: '3'
> 
> services:
>   prometheus:
>     image: prom/prometheus
>     ports:
>       - "9090:9090"
>     volumes:
>       - ./prometheus.yml:/etc/prometheus/prometheus.yml
> 
>   grafana:
>     image: grafana/grafana
>     ports:
>       - "3000:3000"
>     volumes:
>       - grafana-storage:/var/lib/grafana
>     depends_on:
>       - prometheus
> 
> volumes:
>   grafana-storage:
> ```
>
> ### 2. Prometheusé…ç½®
> ```yaml
> # prometheus.yml
> scrape_configs:
>   - job_name: 'spring-app'
>     metrics_path: '/actuator/prometheus'
>     static_configs:
>       - targets: ['host.docker.internal:8080'] # å®¿ä¸»æœºåº”ç”¨åœ°å€
> ```
>
> ---
>
> ## ä¸‰ã€Grafanaå¯è§†åŒ–é…ç½®
>
> ### 1. æ·»åŠ æ•°æ®æº
> 1. è®¿é—® http://localhost:3000
> 2. æ·»åŠ Prometheusæ•°æ®æº
> 3. URLå¡«å†™ `http://prometheus:9090`
>
> ### 2. å¯¼å…¥Dashboard
> ä½¿ç”¨å®˜æ–¹æ¨¡æ¿ID `4701`ï¼Œè‡ªåŠ¨ç”Ÿæˆä»¥ä¸‹ç›‘æ§é¢æ¿ï¼š
>
> | ç›‘æ§é¡¹       | PromQLç¤ºä¾‹                                                   |
> | ------------ | ------------------------------------------------------------ |
> | æ€»QPS        | sum(rate(http_server_requests_seconds_count[1m]))            |
> | å¹³å‡å“åº”æ—¶é—´ | rate(http_server_requests_seconds_sum[1m])/rate(http_server_requests_seconds_count[1m]) |
> | æŒ‰çŠ¶æ€ç ç»Ÿè®¡ | sum by(status) (http_server_requests_seconds_count)          |
>
> ---
>
> ## å››ã€é«˜çº§ç›‘æ§æŠ€å·§
>
> ### 1. è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡
> ```java
> @RestController
> public class OrderController {
> 
>     private final Counter orderCounter;
> 
>     public OrderController(MeterRegistry registry) {
>         orderCounter = registry.counter("order.create.count");
>     }
> 
>     @PostMapping("/orders")
>     public void createOrder() {
>         orderCounter.increment();
>         // ä¸šåŠ¡é€»è¾‘...
>     }
> }
> ```
>
> ### 2. å‘Šè­¦è§„åˆ™é…ç½®
> ```yaml
> # prometheus.yml
> rule_files:
>   - alerts.yml
> ```
>
> ```yaml
> # alerts.yml
> groups:
> - name: spring-alerts
>   rules:
>   - alert: HighErrorRate
>     expr: sum(rate(http_server_requests_seconds_count{status=~'5..'}[5m])) / sum(rate(http_server_requests_seconds_count[5m])) > 0.1
>     for: 10m
> ```
>
> ---
>
> ## äº”ã€å¸¸è§é—®é¢˜æ’æŸ¥
>
> 1. **æŒ‡æ ‡ä¸æ˜¾ç¤ºï¼Ÿ**
>    - æ£€æŸ¥`/actuator/prometheus`ç«¯ç‚¹æ˜¯å¦å¯è¾¾
>    - ç¡®è®¤Prometheus targetsçŠ¶æ€ä¸ºUP
>
> 2. **Dockerç½‘ç»œä¸é€šï¼Ÿ**
>    - ä½¿ç”¨`host.docker.internal`ï¼ˆMac/Winï¼‰
>    - Linuxä½¿ç”¨`--network=host`æ¨¡å¼
>
> 3. **æŒ‡æ ‡å»¶è¿Ÿï¼Ÿ**
>    ```yaml
>    # Prometheusé…ç½®
>    scrape_interval: 15s
>    evaluation_interval: 15s
>    ```
>
> ---
>
> ## æ€»ç»“
>
> é€šè¿‡æœ¬æ–‡çš„é…ç½®ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š
> âœ… å®æ—¶QPSç›‘æ§
> âœ… å“åº”æ—¶é—´åˆ†å¸ƒå¯è§†åŒ–
> âœ… å¼‚å¸¸çŠ¶æ€ç å‘Šè­¦
> âœ… è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡è¿½è¸ª
>
> è¿™å¥—ç›‘æ§æ–¹æ¡ˆæ¯å¤©å¯å¤„ç†ç™¾ä¸‡çº§æŒ‡æ ‡æ•°æ®ï¼Œå†…å­˜æ¶ˆè€—æ§åˆ¶åœ¨500MBä»¥å†…ï¼Œæ˜¯è½»é‡çº§ç›‘æ§çš„ä¼˜é€‰æ–¹æ¡ˆã€‚