# MongoDB Java SDK 全面指南

## 基本概念

MongoDB Java SDK (也称为MongoDB Java Driver)是官方提供的用于在Java应用程序中连接和操作MongoDB数据库的工具包。最新版本为4.x系列，支持同步和异步操作模式。

## 核心类与方法

### 1. 连接相关

| 类/接口        | 方法                                   | 入参                                | 出参              | 示例                                                         |
| -------------- | -------------------------------------- | ----------------------------------- | ----------------- | ------------------------------------------------------------ |
| `MongoClient`  | `MongoClient(String connectionString)` | connectionString: MongoDB连接字符串 | MongoClient实例   | `MongoClient client = new MongoClient("mongodb://localhost:27017")` |
| `MongoClients` | `create(String connectionString)`      | connectionString: MongoDB连接字符串 | MongoClient实例   | `MongoClient client = MongoClients.create("mongodb://localhost:27017")` |
| `MongoClient`  | `getDatabase(String name)`             | name: 数据库名称                    | MongoDatabase实例 | `MongoDatabase db = client.getDatabase("test")`              |
| `MongoClient`  | `close()`                              | 无                                  | void              | `client.close()`                                             |

### 2. 集合操作

| 类/接口         | 方法                            | 入参           | 出参                | 示例                                                         |
| --------------- | ------------------------------- | -------------- | ------------------- | ------------------------------------------------------------ |
| `MongoDatabase` | `getCollection(String name)`    | name: 集合名称 | MongoCollection实例 | `MongoCollection<Document> coll = db.getCollection("users")` |
| `MongoDatabase` | `createCollection(String name)` | name: 集合名称 | void                | `db.createCollection("users")`                               |
| `MongoDatabase` | `listCollectionNames()`         | 无             | MongoIterable       | `for (String name : db.listCollectionNames()) { ... }`       |

### 3. 文档CRUD操作

#### 插入文档

| 方法                            | 入参                        | 出参             | 示例                                                         |
| ------------------------------- | --------------------------- | ---------------- | ------------------------------------------------------------ |
| `insertOne(T document)`         | document: 要插入的文档      | InsertOneResult  | `coll.insertOne(new Document("name", "Alice").append("age", 25))` |
| `insertMany(List<T> documents)` | documents: 要插入的文档列表 | InsertManyResult | `List<Document> docs = ...; coll.insertMany(docs)`           |

#### 查询文档

| 方法                                         | 入参                               | 出参         | 示例                                                         |
| -------------------------------------------- | ---------------------------------- | ------------ | ------------------------------------------------------------ |
| `find()`                                     | 无                                 | FindIterable | `coll.find().forEach(printBlock)`                            |
| `find(Bson filter)`                          | filter: 查询条件                   | FindIterable | `coll.find(eq("name", "Alice"))`                             |
| `findOneAndUpdate(Bson filter, Bson update)` | filter: 查询条件, update: 更新操作 | T            | `coll.findOneAndUpdate(eq("name", "Alice"), set("age", 26))` |

#### 更新文档

| 方法                                     | 入参                                    | 出参         | 示例                                                      |
| ---------------------------------------- | --------------------------------------- | ------------ | --------------------------------------------------------- |
| `updateOne(Bson filter, Bson update)`    | filter: 查询条件, update: 更新操作      | UpdateResult | `coll.updateOne(eq("name", "Alice"), set("age", 26))`     |
| `updateMany(Bson filter, Bson update)`   | filter: 查询条件, update: 更新操作      | UpdateResult | `coll.updateMany(lt("age", 18), inc("age", 1))`           |
| `replaceOne(Bson filter, T replacement)` | filter: 查询条件, replacement: 替换文档 | UpdateResult | `coll.replaceOne(eq("name", "Alice"), new Document(...))` |

#### 删除文档

| 方法                      | 入参             | 出参         | 示例                                  |
| ------------------------- | ---------------- | ------------ | ------------------------------------- |
| `deleteOne(Bson filter)`  | filter: 删除条件 | DeleteResult | `coll.deleteOne(eq("name", "Alice"))` |
| `deleteMany(Bson filter)` | filter: 删除条件 | DeleteResult | `coll.deleteMany(lt("age", 18))`      |

### 4. 聚合操作

| 方法                             | 入参                       | 出参              | 示例                                                         |
| -------------------------------- | -------------------------- | ----------------- | ------------------------------------------------------------ |
| `aggregate(List<Bson> pipeline)` | pipeline: 聚合管道阶段列表 | AggregateIterable | `coll.aggregate(Arrays.asList(match(eq("status", "A")), group("$cust_id", sum("total", "$amount"))))` |

### 5. 索引操作

| 方法                                           | 入参                            | 出参                | 示例                                                         |
| ---------------------------------------------- | ------------------------------- | ------------------- | ------------------------------------------------------------ |
| `createIndex(Bson keys)`                       | keys: 索引键                    | String (索引名称)   | `coll.createIndex(ascending("name"))`                        |
| `createIndex(Bson keys, IndexOptions options)` | keys: 索引键, options: 索引选项 | String (索引名称)   | `coll.createIndex(ascending("name"), new IndexOptions().unique(true))` |
| `listIndexes()`                                | 无                              | ListIndexesIterable | `coll.listIndexes().forEach(printBlock)`                     |

## 常用Bson构建器方法

| 方法                                   | 描述           | 示例                                         |
| -------------------------------------- | -------------- | -------------------------------------------- |
| `eq(String fieldName, Object value)`   | 等于           | `eq("name", "Alice")`                        |
| `lt(String fieldName, Object value)`   | 小于           | `lt("age", 30)`                              |
| `lte(String fieldName, Object value)`  | 小于等于       | `lte("age", 30)`                             |
| `gt(String fieldName, Object value)`   | 大于           | `gt("age", 18)`                              |
| `gte(String fieldName, Object value)`  | 大于等于       | `gte("age", 18)`                             |
| `and(Bson... filters)`                 | 与             | `and(eq("name", "Alice"), gt("age", 20))`    |
| `or(Bson... filters)`                  | 或             | `or(eq("name", "Alice"), eq("name", "Bob"))` |
| `set(String fieldName, Object value)`  | 设置字段值     | `set("age", 26)`                             |
| `inc(String fieldName, Number value)`  | 增加字段值     | `inc("age", 1)`                              |
| `push(String fieldName, Object value)` | 向数组添加元素 | `push("hobbies", "reading")`                 |

## 完整示例

```java
import com.mongodb.client.*;
import com.mongodb.client.model.*;
import org.bson.Document;
import static com.mongodb.client.model.Filters.*;
import static com.mongodb.client.model.Updates.*;

public class MongoDBExample {
    public static void main(String[] args) {
        // 1. 连接MongoDB
        MongoClient client = MongoClients.create("mongodb://localhost:27017");
        MongoDatabase database = client.getDatabase("test");
        MongoCollection<Document> collection = database.getCollection("users");
        
        // 2. 插入文档
        Document doc1 = new Document("name", "Alice")
                        .append("age", 25)
                        .append("status", "A");
        collection.insertOne(doc1);
        
        // 3. 批量插入
        List<Document> documents = Arrays.asList(
            new Document("name", "Bob").append("age", 30).append("status", "A"),
            new Document("name", "Charlie").append("age", 35).append("status", "B")
        );
        collection.insertMany(documents);
        
        // 4. 查询文档
        Document myDoc = collection.find(eq("name", "Alice")).first();
        System.out.println(myDoc.toJson());
        
        // 5. 更新文档
        collection.updateOne(eq("name", "Alice"), set("age", 26));
        
        // 6. 删除文档
        collection.deleteOne(eq("name", "Charlie"));
        
        // 7. 聚合查询
        collection.aggregate(Arrays.asList(
            match(eq("status", "A")),
            group("$name", sum("totalAge", "$age"))
        )).forEach(d -> System.out.println(d.toJson()));
        
        // 8. 创建索引
        collection.createIndex(ascending("name"));
        
        // 9. 关闭连接
        client.close();
    }
}
```

## 异步API

MongoDB Java Driver也提供了异步API，使用`Publisher`接口和响应式流：

```java
MongoClient client = MongoClients.create("mongodb://localhost:27017");
MongoDatabase database = client.getDatabase("test");
MongoCollection<Document> collection = database.getCollection("users");

// 异步查询
Publisher<Document> publisher = collection.find();
publisher.subscribe(new Subscriber<Document>() {
    public void onSubscribe(Subscription s) {
        s.request(Long.MAX_VALUE);
    }
    public void onNext(Document document) {
        System.out.println(document.toJson());
    }
    public void onError(Throwable t) {
        t.printStackTrace();
    }
    public void onComplete() {
        System.out.println("Finished");
    }
});
```

## 注意事项

1. 使用后记得关闭MongoClient连接
2. 批量操作时注意文档大小限制(16MB)
3. 查询大量数据时使用游标
4. 生产环境建议使用连接池
5. 注意BSON和Java类型的映射关系

以上是MongoDB Java SDK的主要功能和用法概述，实际使用时可根据具体需求选择合适的方法和参数。