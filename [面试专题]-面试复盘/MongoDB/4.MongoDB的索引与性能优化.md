# MongoDB Java SDK 索引操作详解

## 索引基础操作

| 方法/操作                                      | 参数                                   | 说明                          | 示例                                                         |
| ---------------------------------------------- | -------------------------------------- | ----------------------------- | ------------------------------------------------------------ |
| **创建索引**                                   |                                        |                               |                                                              |
| `createIndex(Bson keys)`                       | `keys`: 索引键定义                     | 创建简单索引                  | `collection.createIndex(ascending("name"))`                  |
| `createIndex(Bson keys, IndexOptions options)` | `keys`: 索引键定义 `options`: 索引选项 | 创建带选项的索引              | `collection.createIndex(ascending("name"), new IndexOptions().unique(true))` |
| **查看索引**                                   |                                        |                               |                                                              |
| `listIndexes()`                                | 无                                     | 列出集合所有索引              | `collection.listIndexes().forEach(System.out::println)`      |
| **删除索引**                                   |                                        |                               |                                                              |
| `dropIndex(String name)`                       | `name`: 索引名称                       | 删除指定索引                  | `collection.dropIndex("name_1")`                             |
| `dropIndex(Bson keys)`                         | `keys`: 索引键定义                     | 根据键定义删除索引            | `collection.dropIndex(ascending("name"))`                    |
| `dropIndexes()`                                | 无                                     | 删除集合所有索引(除_id索引外) | `collection.dropIndexes()`                                   |

## 索引类型详解

| 索引类型         | 创建方法                               | 说明                    | 示例                                                         |
| ---------------- | -------------------------------------- | ----------------------- | ------------------------------------------------------------ |
| **单字段索引**   | `ascending(field)` `descending(field)` | 单个字段的升序/降序索引 | `collection.createIndex(ascending("name"))`                  |
| **复合索引**     | `compoundIndex(fields...)`             | 多个字段组合索引        | `collection.createIndex(compoundIndex(ascending("name"), descending("age")))` |
| **多键索引**     | `ascending(field)`                     | 数组字段自动创建        | `collection.createIndex(ascending("tags"))`                  |
| **文本索引**     | `text(field)`                          | 全文搜索索引            | `collection.createIndex(text("description"))`                |
| **地理空间索引** | `geo2dsphere(field)` `geo2d(field)`    | 地理空间数据索引        | `collection.createIndex(geo2dsphere("location"))`            |
| **哈希索引**     | `hashed(field)`                        | 哈希分片索引            | `collection.createIndex(hashed("_id"))`                      |

## 索引选项详解

| 选项方法                               | 参数                    | 说明                           | 示例                                                         |
| -------------------------------------- | ----------------------- | ------------------------------ | ------------------------------------------------------------ |
| `unique()`                             | 无                      | 唯一索引                       | `new IndexOptions().unique(true)`                            |
| `sparse()`                             | 无                      | 稀疏索引(只索引包含字段的文档) | `new IndexOptions().sparse(true)`                            |
| `background()`                         | 无                      | 后台创建索引                   | `new IndexOptions().background(true)`                        |
| `name(String name)`                    | `name`: 自定义索引名称  | 指定索引名称                   | `new IndexOptions().name("custom_idx_name")`                 |
| `expireAfter(Long seconds)`            | `seconds`: 过期时间(秒) | TTL索引(自动删除)              | `new IndexOptions().expireAfter(3600L)`                      |
| `partialFilterExpression(Bson filter)` | `filter`: 过滤条件      | 部分索引(只索引符合条件的文档) | `new IndexOptions().partialFilterExpression(gt("age", 18))`  |
| `collation(Collation collation)`       | `collation`: 排序规则   | 指定索引排序规则               | `new IndexOptions().collation(Collation.builder().locale("en").build())` |

## 索引管理最佳实践

| 实践要点         | 说明                          | 代码示例                                                     |
| ---------------- | ----------------------------- | ------------------------------------------------------------ |
| **索引命名**     | 为索引指定有意义的名称        | `new IndexOptions().name("idx_name_age")`                    |
| **复合索引顺序** | 将选择性高的字段放在前面      | `compoundIndex(ascending("status"), ascending("createdAt"))` |
| **部分索引**     | 只为常用查询条件创建索引      | `partialFilterExpression(eq("status", "active"))`            |
| **索引覆盖查询** | 确保查询只使用索引字段        | `projection(include("name", "age"))`                         |
| **监控索引使用** | 使用`$indexStats`评估索引效率 | `db.collection.aggregate([{$indexStats: {}}])`               |

## 完整索引操作示例

```java
import com.mongodb.client.*;
import com.mongodb.client.model.*;
import org.bson.Document;
import static com.mongodb.client.model.Indexes.*;
import static com.mongodb.client.model.Projections.*;

public class MongoDBIndexExample {
    public static void main(String[] args) {
        MongoClient client = MongoClients.create("mongodb://localhost:27017");
        MongoDatabase database = client.getDatabase("test");
        MongoCollection<Document> collection = database.getCollection("users");
        
        // 1. 创建单字段索引
        collection.createIndex(ascending("email"));
        
        // 2. 创建复合索引
        collection.createIndex(
            compoundIndex(ascending("lastName"), descending("createdAt")),
            new IndexOptions().name("name_created_idx")
        );
        
        // 3. 创建唯一索引
        collection.createIndex(
            ascending("username"),
            new IndexOptions().unique(true)
        );
        
        // 4. 创建TTL索引(文档30天后自动删除)
        collection.createIndex(
            ascending("lastModified"),
            new IndexOptions().expireAfter(30L * 24 * 60 * 60)
        );
        
        // 5. 创建部分索引(只索引活跃用户)
        collection.createIndex(
            ascending("location"),
            new IndexOptions()
                .partialFilterExpression(eq("status", "active"))
                .name("active_users_geo_idx")
        );
        
        // 6. 创建文本索引
        collection.createIndex(
            text("bio").text("interests")
        );
        
        // 7. 列出所有索引
        System.out.println("Collection indexes:");
        collection.listIndexes().forEach(System.out::println);
        
        // 8. 删除索引
        collection.dropIndex("name_created_idx");
        
        client.close();
    }
}
```

## 索引性能提示

1. **选择性高的字段**更适合创建索引
2. **写操作频繁**的集合不宜创建过多索引
3. **复合索引字段顺序**影响查询效率
4. 使用`explain()`分析查询是否使用了索引
5. 定期使用`compact`命令整理索引碎片