# Redis主从复制原理知识复习

## 一、主从复制基础概念

### 场景：电商系统读写分离

在电商系统中，主节点存储商品库存（如`product:1001:stock`），从节点处理高并发读请求（如查询库存），但从节点数据滞后导致用户看到错误库存。

#### A. 为什么需要主从复制？

主从复制提供数据冗余，确保高可用；支持读写分离，提升读性能；通过横向扩展从节点，应对高并发读场景。例如，电商系统通过从节点分担主节点压力，降低延迟。

#### B. 主从复制结构与反馈

- 定义与作用

  ：

  - 数据冗余：从节点备份主节点数据，防止单点故障。
  - 读写分离：主节点写，从节点读。
  - 横向扩展：增加从节点提升读QPS。

- 核心角色

  ：

  - 主节点：处理写操作，传播命令。
  - 从节点：同步主节点数据，仅读。
  - 拓扑：级联（主->从->次级从）或环形（从节点间循环同步，较少用）。

- 用户看到的反馈

  ：

  - 从节点查询库存：

    ```
    redis-cli -h slave GET product:1001:stock
    "1000"
    ```

  - 主节点状态：

    ```
    redis-cli> INFO REPLICATION
    role:master
    connected_slaves:2
    ```

- 实战操作

  ：

  1. 配置从节点：

     ```bash
     redis-cli -h slave SLAVEOF master_host 6379
     ```

  2. 检查复制状态：

     ```bash
     redis-cli INFO REPLICATION
     ```

  3. 验证读写分离：

     ```bash
     redis-cli -h slave SET product:1001:stock 1000  # 报错，read-only
     ```

#### C. 面试深入考察应对

1. Q1：读写分离如何保证数据一致性？
   - 答：主从复制是异步的，可能有延迟。优化方法：监控`master_repl_offset`与`slave_repl_offset`差距；优先查询主节点关键数据。
   - 深入Q2：级联复制的优缺点？
     - 答：优点是减少主节点带宽压力；缺点是增加延迟，需合理设计拓扑。
     - 深入Q3：如何选择从节点数量？
       - 答：根据读QPS和硬件资源，测试从节点性能（如`redis-benchmark`）；通常2-4个从节点足够，过多增加同步开销。

------

## 二、复制建立过程

### 场景：新增从节点同步失败

新增从节点执行`SLAVEOF`，但同步失败，日志显示“Connection refused”。

#### A. 为什么需要关注复制建立？

复制建立是主从同步的基础，失败可能导致数据不一致或服务不可用。理解过程有助于快速排查问题。

#### B. 复制建立结构与反馈

- 初始化阶段

  ：

  - `SLAVEOF`触发从节点连接主节点。
  - 从节点状态：`REPL_STATE_CONNECT` -> `REPL_STATE_CONNECTING`.
  - 主节点检查：验证权限、复制ID。

- 全量同步

  ：

  - 主节点生成RDB文件，传输至从节点。
  - 复制缓冲区存储同步期间命令。
  - 从节点加载RDB，执行缓冲命令。

- 部分重同步（PSYNC）

  ：

  - 复制偏移量：记录主从同步进度。
  - 复制ID：标识数据集版本。
  - 断线重连：通过`PSYNC`恢复增量数据。

- 用户看到的反馈

  ：

  - 同步日志：

    ```
    redis-cli> INFO REPLICATION
    master_sync_in_progress:1
    ```

  - 错误日志：

    ```
    [slave] Error connecting to master: Connection refused
    ```

- 实战操作

  ：

  1. 执行

     ```
     SLAVEOF
     ```

     ：

     ```bash
     redis-cli -h slave SLAVEOF 127.0.0.1 6379
     ```

  2. 检查同步状态：

     ```bash
     redis-cli INFO REPLICATION
     ```

  3. 查看日志：

     ```bash
     tail -f /var/log/redis/redis.log
     ```

#### C. 面试深入考察应对

1. Q1：全量同步的性能瓶颈？
   - 答：RDB生成和传输耗时长，占用CPU和带宽。优化：启用无盘复制（`repl-diskless-sync`）。
   - 深入Q2：PSYNC失败如何处理？
     - 答：检查复制ID是否匹配；增大`repl-backlog-size`；重试全量同步。
     - 深入Q3：如何减少同步延迟？
       - 答：优化网络带宽；减少主节点写压力；使用并行复制（Redis 4.0+）。

------

## 三、数据同步核心机制

### 场景：主从数据不一致

主节点更新库存，从节点延迟同步，用户查询到旧数据。

#### A. 为什么需要数据同步机制？

高效同步机制确保主从数据一致，减少延迟，提升用户体验。

#### B. 同步机制结构

- 命令传播

  ：

  - 主节点转发写命令至从节点。
  - 协议：RESP格式，高效传输。
  - 从节点顺序执行命令。

- 心跳检测

  ：

  - 主节点周期发送`PING`（`repl-ping-replica-period`）。
  - 从节点超时检测（`repl-timeout`）。

- 复制积压缓冲区

  ：

  - 环形缓冲区存储近期命令。
  - 配置：`repl-backlog-size`（默认1MB）。
  - 断线恢复：从缓冲区读取增量命令。

- 用户看到的反馈

  ：

  - 主从偏移量差异：

    ```
    redis-cli> INFO REPLICATION
    master_repl_offset:1000
    slave_repl_offset:900
    ```

  - 心跳状态：

    ```
    master_last_io_seconds_ago:1
    ```

- 实战操作

  ：

  1. 检查偏移量：

     ```bash
     redis-cli INFO REPLICATION
     ```

  2. 配置缓冲区：

     ```bash
     redis-cli CONFIG SET repl-backlog-size 10mb
     ```

  3. 调整心跳间隔：

     ```bash
     redis-cli CONFIG SET repl-ping-replica-period 5
     ```

#### C. 面试深入考察应对

1. Q1：如何优化命令传播延迟？
   - 答：增加`repl-backlog-size`；优化网络（压缩、TLS）；减少主节点写压力。
   - 深入Q2：心跳检测的权衡？
     - 答：短间隔（<10s）提高故障检测速度，但增加网络开销；需根据网络稳定性调整。
     - 深入Q3：缓冲区溢出的影响？
       - 答：溢出导致全量同步，增加延迟和带宽消耗。需监控`repl_backlog_active`并调大缓冲区。

------

## 四、复制流程优化技术

### 场景：全量同步耗时长

新增从节点全量同步耗时数分钟，影响服务上线。

#### A. 为什么需要优化复制？

优化复制流程可减少同步时间，提升扩展效率，降低资源消耗。

#### B. 优化技术结构

- 无磁盘复制

  ：

  - 配置：`repl-diskless-sync`。
  - 优势：直接内存传输，省略RDB文件I/O。
  - 场景：高吞吐、低延迟环境。

- 并行复制（Redis 4.0+）

  ：

  - 从节点多线程加载RDB。
  - 提升同步速度30%-50%。

- 级联复制

  ：

  - 从节点作为次级主节点，减少主节点压力。
  - 节省跨机房带宽。

- 用户看到的反馈

  ：

  - 同步时间缩短：

    ```
    redis-cli> INFO REPLICATION
    master_sync_in_progress:0
    master_sync_total_time:5000  # 5秒
    ```

- 实战操作

  ：

  1. 启用无盘复制：

     ```bash
     redis-cli CONFIG SET repl-diskless-sync yes
     ```

  2. 检查同步时间：

     ```bash
     redis-cli INFO REPLICATION
     ```

  3. 配置级联复制：

     ```bash
     redis-cli -h slave2 SLAVEOF slave1 6379
     ```

#### C. 面试深入考察应对

1. Q1：无盘复制的局限性？
   - 答：内存开销大，需确保主节点有足够内存；不支持低版本Redis。
   - 深入Q2：并行复制的适用场景？
     - 答：适合大RDB文件（>100MB）或高并发场景；需测试从节点CPU资源。
     - 深入Q3：级联复制如何避免延迟累积？
       - 答：限制级联层级（1-2层）；监控每层偏移量；优化网络。

------

## 五、复制状态机与异常处理

### 场景：从节点断线重连失败

从节点因网络闪断丢失连接，尝试重连失败，需排查问题。

#### A. 为什么需要关注状态机与异常？

状态机管理复制流程，异常处理影响数据一致性和可用性。

#### B. 状态机与异常结构

- 状态转换

  ：

  - `REPL_STATE_CONNECT`：初始连接。
  - `REPL_STATE_CONNECTING`：建立TCP连接。
  - `REPL_STATE_TRANSFER`：传输RDB。
  - `REPL_STATE_CONNECTED`：正常同步。

- 故障处理

  ：

  - 网络闪断：尝试`PSYNC`，失败则全量同步。
  - 主从切换：通过Sentinel或手动`SLAVEOF NO ONE`。
  - 数据一致性：校验偏移量。

- 中断原因

  ：

  - 超时：`repl-timeout`触发。
  - 缓冲区溢出：`repl-backlog-size`不足。
  - 权限失败：`requirepass`不匹配。

- 用户看到的反馈

  ：

  - 状态异常：

    ```
    redis-cli> INFO REPLICATION
    master_link_status:down
    ```

  - 错误日志：

    ```
    [slave] Failed to authenticate with master
    ```

- 实战操作

  ：

  1. 检查状态：

     ```bash
     redis-cli INFO REPLICATION
     ```

  2. 重试连接：

     ```bash
     redis-cli SLAVEOF master_host 6379
     ```

  3. 验证权限：

     ```bash
     redis-cli -a password PING
     ```

#### C. 面试深入考察应对

1. Q1：如何快速恢复网络闪断？
   - 答：增大`repl-backlog-size`和`repl-timeout`；优先尝试`PSYNC`。
   - 深入Q2：主从切换如何保证零数据丢失？
     - 答：结合Sentinel实现自动切换；同步写操作需等待从节点确认。
     - 深入Q3：一致性校验的实现？
       - 答：比较主从`repl_offset`；使用外部工具（如`redis-rdb-tools`）校验RDB。

------

## 六、配置管理与监控

### 场景：从节点返回过期数据

从节点配置`replica-serve-stale-data yes`，导致用户查询到过期库存。

#### A. 为什么需要配置与监控？

合理配置和监控确保复制稳定，及时发现异常，提升系统可靠性。

#### B. 配置与监控结构

- 关键配置

  ：

  - `replica-serve-stale-data`：是否返回过期数据。
  - `replica-read-only`：从节点只读。
  - `repl-ping-replica-period`：心跳间隔。
  - `repl-timeout`：超时时间。

- 监控指标

  ：

  - `master_link_status`：连接状态。
  - `master_last_io_seconds_ago`：最后通信时间。
  - `master_sync_in_progress`：同步状态。
  - `repl_backlog_active`：缓冲区使用。

- 查看命令

  ：

  - `INFO REPLICATION`：复制状态。
  - `ROLE`：节点角色。
  - `CLIENT LIST`：客户端连接。

- 用户看到的反馈

  ：

  - 连接断开：

    ```
    master_link_status:down
    ```

  - 同步进行中：

    ```
    master_sync_in_progress:1
    ```

- 实战操作

  ：

  1. 检查配置：

     ```bash
     redis-cli CONFIG GET replica-serve-stale-data
     ```

  2. 监控状态：

     ```bash
     redis-cli INFO REPLICATION
     ```

  3. 查看角色：

     ```bash
     redis-cli ROLE
     ```

#### C. 面试深入考察应对

1. Q1：replica-serve-stale-data的权衡？
   - 答：`yes`提高可用性但可能返回旧数据；`no`保证一致性但可能拒绝请求。
   - 深入Q2：如何监控复制延迟？
     - 答：通过`master_last_io_seconds_ago`和`repl_offset`差值；设置Prometheus告警。
     - 深入Q3：如何自动化异常处理？
       - 答：使用脚本监控`INFO REPLICATION`，自动重连或切换主节点。

------

## 七、生产环境实践

### 场景：跨机房主从部署

跨机房主从复制因网络延迟导致同步缓慢，需优化配置。

#### A. 为什么需要生产实践？

生产环境复杂，需针对性优化，确保复制性能和稳定性。

#### B. 生产实践结构

- 部署建议

  ：

  - 网络：低延迟、高带宽。
  - 配置：主从硬件一致，跨机房部署从节点。

- 性能调优

  ：

  - 增大`repl-backlog-size`（如10MB）。
  - 缩短`repl-ping-replica-period`（如5s）。
  - 批量命令：减少网络开销。

- 安全配置

  ：

  - 认证：设置`requirepass`。
  - TLS：启用加密传输。

- 用户看到的反馈

  ：

  - 延迟降低：

    ```
    master_last_io_seconds_ago:1
    ```

  - 安全日志：

    ```
    [slave] TLS connection established
    ```

- 实战操作

  ：

  1. 配置缓冲区：

     ```bash
     redis-cli CONFIG SET repl-backlog-size 10mb
     ```

  2. 启用TLS：

     ```bash
     redis-cli CONFIG SET tls-port 6380
     ```

  3. 设置认证：

     ```bash
     redis-cli CONFIG SET requirepass mypassword
     ```

#### C. 面试深入考察应对

1. Q1：跨机房部署的挑战？
   - 答：高延迟和带宽限制；需压缩传输、优化心跳间隔。
   - 深入Q2：TLS对性能的影响？
     - 答：增加CPU和延迟，需权衡安全性与性能；使用硬件加速（如SSL卸载）。
     - 深入Q3：如何处理批量命令？
       - 答：使用`MULTI/EXEC`或Pipeline减少网络往返；测试批量大小。

------

## 八、版本演进与改进

### 场景：升级Redis以提升复制效率

公司从Redis 3.2升级到6.0，需评估复制改进效果。

#### A. 为什么需要关注版本演进？

新版本提供更高效的复制机制，降低延迟，提升稳定性。

#### B. 版本演进结构

- Redis 2.8

  ：

  - 引入`PSYNC`，支持部分重同步。

- Redis 4.0

  ：

  - 从节点处理过期键，减少主节点压力。
  - 提升复制稳定性。

- Redis 6.0+

  ：

  - 副本代理：从节点转发命令。
  - 无盘复制改进：内存传输优化。
  - 多线程I/O：加速同步。

- 用户看到的反馈

  ：

  - 同步时间缩短：

    ```
    master_sync_total_time:3000  # 3秒
    ```

  - 偏移量一致：

    ```
    master_repl_offset:1000
    slave_repl_offset:1000
    ```

- 实战操作

  ：

  1. 启用无盘复制：

     ```bash
     redis-cli CONFIG SET repl-diskless-sync yes
     ```

  2. 配置多线程：

     ```bash
     redis-cli CONFIG SET io-threads 4
     ```

#### C. 面试深入考察应对

1. Q1：PSYNC如何提升效率？
   - 答：通过复制偏移量和ID，避免全量同步，减少带宽和时间。
   - 深入Q2：副本代理的适用场景？
     - 答：适合级联复制，减少主节点负载；需测试代理层延迟。
     - 深入Q3：多线程I/O的局限性？
       - 答：仅优化网络传输，逻辑处理仍单线程；需结合分片优化。

------

## 九、特殊场景处理

### 场景：大键复制阻塞主节点

复制大键（如Hash含10万field）导致主节点阻塞。

#### A. 为什么需要特殊处理？

大键、高延迟网络和主从切换可能引发性能问题，需针对性优化。

#### B. 特殊场景结构

- 大键复制

  ：

  - 挑战：RDB生成和传输耗时。
  - 优化：分片存储；无盘复制。

- 高延迟网络

  ：

  - 调整：增大`repl-timeout`；启用压缩。

- 主从切换

  ：

  - 手动：`SLAVEOF NO ONE`。
  - 自动：结合Sentinel。

- 用户看到的反馈

  ：

  - 慢查询：

    ```
    redis-cli> SLOWLOG GET
    1) 1) (integer) 1234
       2) (integer) 1698765432
       3) (integer) 10000  # 10ms
       4) 1) "SYNC"
    ```

- 实战操作

  ：

  1. 分片存储：

     ```bash
     redis-cli HMSET bigkey:shard1 field1 value1
     ```

  2. 调整超时：

     ```bash
     redis-cli CONFIG SET repl-timeout 60
     ```

  3. 触发切换：

     ```bash
     redis-cli SLAVEOF NO ONE
     ```

#### C. 面试深入考察应对

1. Q1：如何优化大键复制？
   - 答：拆分大键为多个小键；使用无盘复制；异步删除（`UNLINK`）。
   - 深入Q2：高延迟网络的应急措施？
     - 答：增大`repl-timeout`；启用`repl-compression`；优化网络（如VPN）。
     - 深入Q3：主从切换如何避免数据丢失？
       - 答：确保`repl_backlog`包含最新命令；结合Sentinel等待从节点确认。